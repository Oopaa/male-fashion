<%- include('../partials/userheader') %>

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h3 class="page-title"> Cart</h3>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            
	
            <div class="page-content">
            	<div class="cart">
	                <div class="container">
	                	<div class="row">
	                		<div class="col-lg-9">
	                			<table id="myTable" class="table table-cart table-mobile">
							<% if (user.length > 0) { %>	
									<thead>
							
										<tr>
											<th>Product</th>
											<th>Price</th>
											<th>Quantity</th>
											<th>Total</th>
											<th></th>
										</tr>
									</thead>
                                    <% user.forEach(function(address) { %>
									<tbody>
										<tr>
											<td class="product-col">
											<input class="form-check-input address" id="<%=address.id %>" type="radio" value="<%=address.id %>" name="customerAddress" >
								    				<h3 class="card-title "> Address</h3><!-- End .card-title -->
														<p ><%= address.address1 %><br>
														<%=address.address2%>	
														<%=address.city%><br>
														<%=address.country%>	<br>
														<%=address.landmark%>	<br>
														<%=address.zipcode%>
														<a class="nav-link" id="tab-add-link"  href="/profile"  >Add New address<i class="icon-edit"></i></a></p>
											</td>
											
											
										</tr>

										<% }); %>
									</tbody>
									<% } else { %>
									<tbody>
										
											<tr>
												<td class="product-col">
													<div class="product">
														<figure class="product-media">
															<a href="#">
																
															</a>
														</figure>
	
														<h3 class="product-title">
															<a href="#">Empty cart </a>
														</h3>
													</div>
												</td>
												
											</tr>
											<% } %>
									</tbody>
								</table><!-- End .table table-wishlist -->

	                			<div class="cart-bottom">
			            			<!-- End .cart-discount -->

			            			<a href="#" class="btn btn-outline-dark-2"><span>UPDATE CART</span><i class="icon-refresh"></i></a>
		            			</div><!-- End .cart-bottom -->
	                		</div><!-- End .col-lg-9 -->
	                		<aside class="col-lg-3">
	                			<div class="summary summary-cart">
	                				<h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

	                				<table class="table table-summary">
	                					
                                            <thead>
		                						<tr>
		                							<th>Product</th>
		                							<th>Total</th>
		                						</tr>
		                					</thead>
											
		                					<tbody >
												
												<% cart.forEach(function(product) { %>
													<% product.product.forEach(function(product) { %>

										   
		                						<tr >
													
		                							<td><%=product.product_id.productName%></td>
													
													
											     <% let total = product.product_id.price * product.product_id.isselected%>
                                                    <input type="hidden" class="itemquantity" value="<%=product.product_id.isselected%>">
		                							<td class="Rs"><%=total%></td>
													
		                						</tr>
												
												<% }); %>
												<% }); %>
		                					
                                            </tbody>
                                        </table> 
                                        <table class="table table-summary">
											<tbody>
										<tr class="summary-subtotal">
													
													
											<td>Subtotal:</td>
											<td id="subtotal"></td>
										</tr>
										<tr>
											<td>Coupn Amount</td>
											<td ><p id="dis">0</p></td>
										</tr>
										<tr class="summary-total">
											<td>Total:</td>
											<td id="finaltotal"></td>
										</tr>

									
									</table>
                                    <div class="accordion-summary" id="accordion-payment">
                                        <div class="card">
                                            <div class="card-header" id="heading-1">
                                                <h2 class="card-title">
                                                    <a role="radio" class="collapsed method"  data-toggle="collapse" data-method="bank transfer" href="#collapse-1" aria-expanded="true" aria-controls="collapse-1">
                                                        Direct bank transfer
                                                    </a>
                                                </h2>
                                            </div><!-- End .card-header -->
                                            
                                        </div><!-- End .card -->

                            

                                        <div class="card">
                                            <div class="card-header" id="heading-3">
                                                <h2 class="card-title">
                                                    <a class="collapsed method" role="radio" data-method="COD" value="COD" data-toggle="collapse" href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
                                                        Cash on delivery
                                                    </a>
                                                </h2>
                                            </div><!-- End .card-header -->
                                          
                                        </div><!-- End .card -->

                                        <div class="card">
                                            <div class="card-header" id="heading-4">
                                                <h2 class="card-title">
                                                    <a class="collapsed method" role="radio" data-method="paypal" value="Razorpay" data-toggle="collapse" href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
                                                        Razorpay <small class="float-right paypal-link">What is Razorpay?</small>
                                                    </a>
                                                </h2>
                                            </div><!-- End .card-header -->
                                          
                                        </div><!-- End .card -->

                                        <div class="card">
                                            <div class="card-header" id="heading-5">
                                                <h2 class="card-title">
                                                    <a class="collapsed method"  role="radio" data-method="stripe" data-toggle="collapse" href="#collapse-5" aria-expanded="false" aria-controls="collapse-5">
                                                        Credit Card (Stripe)
                                                        <img src="assets/images/payments-summary.png" alt="payments cards">
                                                    </a>
                                                </h2>
                                            </div><!-- End .card-header -->
                                          
                                        </div><!-- End .card -->
                                    </div><!-- End .accordion -->

	                				<a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
	                			</div>	<!-- End .summary -->

		            			<a href="category.html" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
	                		</aside><!-- End .col-lg-3 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .cart -->
            </div>
        </main>

<script src="https://code.jquery.com/jquery-3.6.4.slim.js" integrity="sha256-dWvV84T6BhzO4vG6gWhsWVKVoa4lVmLnpBOZh/CAHU4=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>
<script>
	
	$(document).ready(function() {
    update_amounts();




  function update_amounts() {
    let subtotal = 0;
    $('#mytabel > tbody > tr').each(function() {
      let price = $(this).find('.Rs').text().replace(/[^\d\.]/g, '')
      let total = parseInt(price);
	//   console.log(price);
      subtotal += total;
	//   console.log(subtotal);
	  
    });
	
    let couponrs = 0 ; 
    let total = subtotal - couponrs;
  
    $('#subtotal').text('â‚¹' + subtotal.toFixed(2));
	
    $('#finaltotal').text( total.toFixed(2));
  }
});

$('.sub').on('click',function(){
	console.log("clicked");
	var coupon = $('#coupon').val()
	

	 $.ajax({
		url:'/checkvalidcoupon?id='+coupon,
		methode:"get",
		success:function(responce){
			if(responce.message =="1"){
			var couponAmount = responce.coupon.couponAmount	
			console.log(couponAmount);
			var miAmount = responce.coupon.minimumAmount
			console.log(miAmount);
			var producttotal = $('#subtotal').text().replace(/[^\d\.]/g, '')
			console.log(producttotal);
			if(producttotal >= miAmount){
			var total = producttotal - couponAmount	
			document.getElementById('finaltotal').innerHTML = total;	
             document.getElementById("dis").innerHTML=responce.coupon.couponAmount
			 Swal.fire({
                            title: "Success",
                            text: "Coupon is Redeemed happy Shopping ",
                            icon: "success",
                            confirmButtonText: "OK"
                        }); 
			}else{
				Swal.fire({
                            title: "Error",
                            text: "Coupon only apply above 500 purchase Amount ",
                            icon: "error",
                            confirmButtonText: "OK"
                        }); 
			}
			}else{
				Swal.fire({
                            title: "Error",
                            text: responce.message,
                            icon: "error",
                            confirmButtonText: "OK"
                        }); 
			}

		}
	})
})

$('#payment').on('click',function(){
var address = $('input[name=customerAddress]:checked').val()
var paymentMethod=$('.accordion-summary .card-header .method[aria-expanded="true"]').data('method')
var discount =$('#dis').text().trim()
var purchase =$('#finaltotal').text().trim()
var itemquantity=$('.itemquantity').val()

var data ={
	"paymentmethod":paymentMethod,
	"discount":discount,
	"purchase":purchase,
	"address":address,
	"itemquantity":itemquantity
}
$.ajax({
	url:'/orderdeatils',
	method:"post",
	data:data,

	success:function(responce){
		console.log(responce.send.paymentMethod); 
		if(responce.message == "1" && responce.send.paymentMethod == "COD"){
			
			Swal.fire({
                            title: "Success",
                            text: "Order is placed successfully",
                            icon: "success",
                            confirmButtonText: "OK"
                        }).then((result)=>{
                            if(result.isConfirmed){
                                window.location.href ="/profile"; // Redirect to profile page
                            }
                        }) 
		}else if(responce.message == "1" && responce.send.paymentMethod == "paypal"){

			Swal.fire({
                            title: "Success",
                            text: "Order is placed successfully",
                            icon: "success",
                            confirmButtonText: "OK"
                        }).then((result)=>{
                            if(result.isConfirmed){
                                window.location.href ="/onlinepayment"; // Redirect to payment  page
                            }
                        })
		}
		else{
			Swal.fire({
                            title: "Error",
                            text: "Something went worng try again after sometimes",
                            icon: "error",
                            confirmButtonText: "OK"
                        }) 
		}
	}
})

})





</script>



        <%- include('../partials/userfooter') %>